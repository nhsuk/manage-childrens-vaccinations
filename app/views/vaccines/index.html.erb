<% page_title = "Vaccines" %>

<%= h1 page_title, page_title:, size: "xl" %>

<% @vaccines.each do |vaccine| %>
  <%= render AppCardComponent.new(heading: "#{vaccine.brand} (#{vaccine.type})") do %>
    <p class="nhsuk-body-s nhsuk-secondary-text-color">
      <%= vaccine.supplier %>,
      GTIN: <span class="app-u-monospace"><%= vaccine.gtin %></span>
    </p>

    <p>
      <%= link_to "Add a batch", new_vaccine_batch_path(vaccine) %>
    </p>

    <% if vaccine.batches.any? %>
      <%= govuk_table do |table| %>
        <%= table.with_head do |head| %>
          <%= head.with_row do |row| %>
            <%= row.with_cell(text: "Batch") %>
            <%= row.with_cell(text: "Entered date") %>
            <%= row.with_cell(text: "Expiry date") %>
            <%= row.with_cell(text: "Actions") %>
          <% end %>
        <% end %>

        <%= table.with_body do |body| %>
          <% vaccine.batches.order(:name).each do |batch| %>
            <% body.with_row do |row| %>
              <% row.with_cell(text: batch.name) do %>
                <%= batch.name %>
                <% if batch.id == @todays_batch_id %>
                  <br>
                  <span class="nhsuk-caption-m">
                    (Your default)
                  </span>
                <% end %>
              <% end %>
              <% row.with_cell(text: batch.created_at.to_fs(:nhsuk_date)) %>
              <% row.with_cell(text: batch.expiry.to_fs(:nhsuk_date)) %>
              <% row.with_cell do %>
                <% if batch.id == @todays_batch_id %>
                  <%= form_tag remove_default_vaccine_batch_path(batch, vaccine_id: batch.vaccine.id), method: :post do %>
                    <%= submit_tag "Remove default", class: "nhsuk-button nhsuk-button--secondary app-button--small" %>
                  <% end %>
                <% else %>
                  <%= form_tag make_default_vaccine_batch_path(batch, vaccine_id: batch.vaccine.id), method: :post do %>
                    <%= submit_tag "Make default", class: "nhsuk-button nhsuk-button--secondary app-button--small" %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>
