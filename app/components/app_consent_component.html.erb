<%= render AppConsentStatusComponent.new(patient_session:) %>

<% if patient_session.no_consent? %>
  <p class="app-status">
    No response yet
  </p>
<% end %>

<% if patient_session.consents.present? %>
  <% consents_grouped_by_parent.each do |summary, consents| %>
    <%= render AppDetailsComponent.new(summary:, open: open_consents?) do %>
      <%= render AppConsentDetailsComponent.new(consents:) %>

      <% if consents.any?(&:response_refused?) %>
        <p><%= contact_parent_or_guardian_link(consents) %></p>
      <% elsif consents.any?(&:response_not_provided?) %>
        <%= govuk_button_link_to(
          "Get consent",
          edit_session_patient_nurse_consents_path(
            session,
            patient,
            @route,
            consent_id: consents.first.id
          ),
          secondary: true
        ) %>
      <% end %>
    <% end %>
  <% end %>

  <%= if display_health_questions?
    render AppDetailsComponent.new(
      summary: "Responses to health questions",
      open: open_health_questions?,
      expander: true
    ) do
      render AppHealthQuestionsComponent.new(consents: @patient_session.consents)
    end
  end %>
<% else %>
  <p>
    <%= govuk_button_link_to(
      "Get consent",
      Flipper.enabled?(:new_consents) ?
        session_patient_manage_consent_path(session, patient, @route, :who) :
        new_session_patient_nurse_consents_path(session, patient, @route)
    ) %>

    <% if display_gillick_consent_button? %>
      <%= govuk_button_link_to(
        "Assess Gillick competence",
        assessing_gillick_session_patient_nurse_consents_path(
          session,
          patient,
          route: @route
        ),
        secondary: true
      ) %>
    <% end %>
  </p>
<% end %>
